<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Custom Challenges</title>
        <link rel="stylesheet" href="/styles.css">
    </head>

    <body style="display: flex; flex-direction: row;">
        <div style="width: 50%;">
            <form id="form">
                <input type="text" id="nickname" placeholder="nickname" required />
                <input type="text" id="password" placeholder="password" required />
                <button type="submit">Enter</button>
            </form>

            <div id="welcome"></div>

            <div id="verified" style="display: none;">
                <button onclick="challenge()">Challenge</button>
            </div>

            <div id="all-users" style="margin-top: 30px;"></div>
        </div>
        <div id="my-challenges" style="width: 50%;"></div>


        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();
            var verified = false;

            document.getElementById('form').addEventListener('submit', (event) => {
                event.preventDefault();

                const nickname = document.getElementById('nickname').value;
                const password = document.getElementById('password').value;
                if (nickname && nickname.trim()) {
                    socket.emit('user', { nickname, password });
                }
            })

            function challenge() {
                if (verified) {
                    let title = window.prompt("Activity title");
                    let challenge = window.prompt("Describe the challenge");
                    let poster = document.getElementById('nickname').value;
                    let opponent = window.prompt("Who are you challenging?");

                    socket.emit('challenge', { title, challenge, poster, opponent });
                }
            }

            function displayUsersList() {
                fetch(`/all-users`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('all-users');
                        container.innerHTML = '';
                        data.forEach(user => {
                            if (user.name === document.getElementById("nickname").value) {
                                return
                            }
                            const div = document.createElement('div');
                            div.textContent = user.name;
                            container.appendChild(div);
                        });
                    })
                    .catch(error => console.error(`Error fetching /all-users :`, error));
            }

            function displayMyChallenges() {
                const nickname = document.getElementById("nickname").value;
                fetch(`/${nickname}/challenges`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(data)
                        const myChallenges = document.getElementById('my-challenges');
                        myChallenges.innerHTML = '';

                        data.forEach(challenge => {
                            let container = document.createElement('div');
                            container.className = "challenge";

                            let div1 = document.createElement('div');
                            div1.textContent = challenge.title;
                            container.appendChild(div1);

                            let div2 = document.createElement('div');
                            div2.textContent = challenge.activity;
                            container.appendChild(div2);

                            let div3 = document.createElement('div');
                            div3.textContent = "Assignees: " + challenge.players.map(player => player.name).join(', ');
                            container.appendChild(div3);

                            let button = document.createElement('button');
                            button.innerHTML = "Done";
                            button.className = "challenge-done";
                            container.appendChild(button);

                            myChallenges.appendChild(container);
                        });
                    })
                    .catch(error => console.error(`Error fetching /${nickname}/challenges :`, error));
            }

            socket.on('display-all-users', () => {
                displayUsersList();
            })

            socket.on('display-my-challenges', () => {
                displayMyChallenges();
            })

            socket.on('logged-in', (nickname) => {
                verified = true;
                document.getElementById("form").style.display = "none";
                document.getElementById("verified").style.display = "block";
                document.getElementById("welcome").innerText = "Welcome, " + nickname + "!";

                displayUsersList();
                displayMyChallenges();
            })
        </script>
    </body>
</html>
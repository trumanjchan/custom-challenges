<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Custom Challenges</title>
        <link rel="stylesheet" href="/styles.css">
    </head>

    <body>
        <form id="form">
            <input type="text" id="nickname" placeholder="nickname" required />
            <input type="text" id="password" placeholder="password" required />
            <button type="submit">Enter</button>
        </form>

        <div id="welcome"></div>

        <div id="verified" style="display: none;">
            <button onclick="challenge()">Challenge</button>
        </div>

        <div id="all-users"></div>


        <script src="/socket.io/socket.io.js"></script>
        <script>
            const socket = io();
            var verified = false;

            document.getElementById('form').addEventListener('submit', (event) => {
                event.preventDefault();

                const nickname = document.getElementById('nickname').value;
                const password = document.getElementById('password').value;
                if (nickname && nickname.trim()) {
                    socket.emit('user', { nickname, password });
                }
            })

            function displayUsersList(nickname) {
                fetch(`/all-users`)
                    .then(response => response.json())
                    .then(data => {
                        const container = document.getElementById('all-users');
                        container.innerHTML = '';
                        data.forEach(user => {
                            if (user.name === nickname) {
                                return
                            }
                            const div = document.createElement('div');
                            div.textContent = user.name;
                            container.appendChild(div);
                        });
                    })
                    .catch(error => console.error(`Error fetching /all-users :`, error));
            }

            function challenge() {
                if (verified) {
                    let title = window.prompt("Activity title");
                    let challenge = window.prompt("Describe the challenge");
                    let poster = document.getElementById('nickname').value;
                    let opponent = window.prompt("Who are you challenging?");

                    socket.emit('challenge', { title, challenge, poster, opponent });
                }
            }

            socket.on('display-all-users', () => {
                displayUsersList();
            })

            socket.on('logged-in', (nickname) => {
                verified = true;
                document.getElementById("form").style.display = "none";
                document.getElementById("verified").style.display = "block";
                document.getElementById("welcome").innerText = "Welcome, " + nickname + "!";

                displayUsersList(nickname);
            })
        </script>
    </body>
</html>